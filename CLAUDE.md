# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is the **ortelius-pdvd-charts** repository, which maintains a Helm umbrella chart for deploying PDVD (Post-Deployment Vulnerability Detection and AI Remediation). The chart aggregates multiple subcharts into a unified deployment package.

## Architecture

### Umbrella Chart Structure

This repository uses a **chart generation pattern** rather than manual chart maintenance:

1. **Chart Generator (`main.js`)**: A Node.js script that dynamically generates `charts/pdvd/Chart.yaml` by:
   - Fetching the latest versions of dependency charts from their respective GitHub Pages repositories
   - Auto-incrementing the patch version based on the current main branch version
   - Updating version references in `charts/pdvd/README.md`

2. **Dependency Charts**: The umbrella chart depends on four subcharts:
   - `pdvd-arangodb` - Database layer (ArangoDB)
   - `pdvd-backend` - Backend API services
   - `pdvd-frontend` - Frontend UI
   - `pdvd-osvdev-job` - OSV.dev vulnerability scanning job

3. **Automated Release**: On push to main, GitHub Actions runs the chart generator and publishes the updated chart to GitHub Pages via the `helm-chart-releaser` workflow.

### Key Files

- `main.js` - Chart generator script
- `charts/pdvd/Chart.yaml` - Generated umbrella chart definition (DO NOT edit manually)
- `charts/pdvd/values.yaml` - Configuration overrides for subcharts
- `charts/pdvd/README.md` - User-facing documentation with installation instructions
- `.github/workflows/helm-chart-releaser.yml` - CI/CD pipeline for chart releases

## Common Commands

### Generate the Chart

The chart generation script must be run with dependencies installed:

```bash
# Install dependencies first
npm install

# Generate new Chart.yaml
node main.js
```

This will:
- Query GitHub APIs for the latest subchart versions from each dependency's `gh-pages` branch
- Auto-increment the patch version
- Write the generated YAML to `charts/pdvd/Chart.yaml`
- Update version references in `charts/pdvd/README.md`

### Linting

The project uses MegaLinter for code quality:

```bash
# MegaLinter runs automatically in CI
# Configuration in .mega-linter.yml
```

Note: YAML linting excludes `templates/` directories (though this chart has no templates directory currently).

## Development Workflow

1. **Never manually edit `charts/pdvd/Chart.yaml`** - It's generated by `main.js`
2. To update dependency versions: The script automatically fetches the latest versions
3. To modify chart metadata: Edit the hardcoded values in `main.js` (lines 69-79)
4. To change subchart configuration: Edit `charts/pdvd/values.yaml`
5. Commit changes trigger automatic chart generation and release via GitHub Actions

## Important Notes

- The chart version follows semantic versioning: `major.minor.patch`
- Patch version auto-increments on every run based on the latest published version
- The generator fetches the **latest** version of each subchart by comparing `created` timestamps
- Dependency repositories must have their charts published to `gh-pages` branch with an `index.yaml` file
- The umbrella chart has no templates of its own - it purely aggregates subcharts
